import logging
from typing import Dict, List

# 1. æ¨¡æ‹Ÿæ•°æ®åº“ï¼šæ·±åœ³æˆ¿æºæ•°æ®
logger = logging.getLogger(__name__)

MOCK_HOUSES = [
    {"id": "SZ001", "area": "å—å±±", "location": "ç§‘æŠ€å›­", "type": "ä¸€å±…å®¤", "price": 6500, "desc": "è…¾è®¯å¤§å¦æ—ï¼Œæ­¥è¡Œä¸Šç­ï¼Œç²¾è£…å…¨é…ï¼Œé€‚åˆç¨‹åºå‘˜ã€‚", "tags": ["è¿‘å¤§å‚", "ç²¾è£…"]},
    {"id": "SZ002", "area": "å—å±±", "location": "åæµ·", "type": "ä¸¤å±…å®¤", "price": 8500, "desc": "æµ·å²¸åŸå•†åœˆï¼Œé«˜å±‚æµ·æ™¯ï¼Œé‡‡å…‰æ— æ•Œã€‚", "tags": ["å•†åœˆ", "æµ·æ™¯"]},
    {"id": "SZ003", "area": "å—å±±", "location": "è¥¿ä¸½", "type": "åˆç§Ÿ", "price": 2800, "desc": "æ·±å¤§é™„è¿‘ï¼Œæ°‘æ°´æ°‘ç”µï¼Œå¸¦å¤§é˜³å°ã€‚", "tags": ["æ€§ä»·æ¯”", "é«˜æ ¡"]},
    {"id": "SZ004", "area": "ç¦ç”°", "location": "è½¦å…¬åº™", "type": "ä¸€å±…å®¤", "price": 5800, "desc": "åœ°é“å››çº¿äº¤æ±‡ï¼Œäº¤é€šæå…¶ä¾¿åˆ©ï¼Œå•†åŠ¡åŒºæ ¸å¿ƒã€‚", "tags": ["äº¤é€šä¾¿åˆ©", "å•†åŠ¡åŒº"]},
    {"id": "SZ005", "area": "ç¦ç”°", "location": "çŸ³å¦", "type": "ä¸¤å±…å®¤", "price": 7200, "desc": "åŒºæ”¿åºœæ—ï¼Œæ²»å®‰å¥½ï¼Œç¯å¢ƒå®‰é™ï¼Œé€‚åˆå®¶åº­ã€‚", "tags": ["å®‰é™", "æ²»å®‰å¥½"]},
    {"id": "SZ006", "area": "å®å®‰", "location": "è¥¿ä¹¡", "type": "å¤§å¼€é—´", "price": 3200, "desc": "1å·çº¿åœ°é“å£ï¼Œåªæ´²ç”Ÿæ´»åœˆï¼Œåƒå–ç©ä¹åº”æœ‰å°½æœ‰ã€‚", "tags": ["ç”Ÿæ´»ä¾¿åˆ©", "åœ°é“å£"]},
    {"id": "SZ007", "area": "å®å®‰", "location": "å®å®‰ä¸­å¿ƒ", "type": "ä¸‰å±…å®¤", "price": 9000, "desc": "å£¹æ–¹åŸæ—ï¼Œé«˜ç«¯å°åŒºï¼Œå¸¦è½¦ä½ï¼Œçœ‹å‰æµ·æ¹¾ã€‚", "tags": ["é«˜ç«¯", "å¸¦è½¦ä½"]},
    {"id": "SZ008", "area": "é¾™å", "location": "æ·±åœ³åŒ—ç«™", "type": "ä¸¤å±…å®¤", "price": 5000, "desc": "é«˜é“æ¢çº½ï¼Œçº¢å±±6979æ—ï¼Œå…¨æ–°è£…ä¿®ã€‚", "tags": ["æ–°æˆ¿", "é«˜é“"]},
    {"id": "SZ009", "area": "é¾™å", "location": "æ°‘æ²»", "type": "ä¸€å±…å®¤", "price": 3800, "desc": "ç”Ÿæ´»æ°”æ¯æµ“åšï¼Œæ¥¼ä¸‹å°±æ˜¯å¤§æ¶¦å‘ï¼Œæˆ¿ä¸œç›´ç§Ÿã€‚", "tags": ["æˆ¿ä¸œç›´ç§Ÿ", "ä¾¿å®œ"]},
    {"id": "SZ010", "area": "ç½—æ¹–", "location": "å›½è´¸", "type": "ä¸€å±…å®¤", "price": 4200, "desc": "è€ç‰Œå•†ä¸šåŒºï¼Œé‡‘å…‰åå¹¿åœºæ—ï¼Œé…å¥—æˆç†Ÿã€‚", "tags": ["æˆç†Ÿå•†åœˆ", "ä¾¿åˆ©"]},
]

def search_houses(keywords: List[str]) -> List[Dict]:
    """
    æ ¹æ®å…³é”®è¯åˆ—è¡¨æœç´¢æˆ¿æºï¼ˆç®€å•çš„ Mock å®ç°ï¼‰ã€‚
    
    é€»è¾‘ï¼š
    1. éå†æ‰€æœ‰æˆ¿æºã€‚
    2. å°†æˆ¿æºçš„æ‰€æœ‰æ–‡æœ¬å­—æ®µæ‹¼åœ¨ä¸€èµ·ã€‚
    3. åªè¦å…³é”®è¯å‡ºç°åœ¨æˆ¿æºä¿¡æ¯ä¸­ï¼Œå°±ç®—å‘½ä¸­ã€‚
    4. å¯¹ä»·æ ¼åšç‰¹æ®Šå¤„ç†ï¼ˆç®€å•çš„æ•°å­—åŒ¹é…ï¼Œå®é™…é¡¹ç›®éœ€è¦è§£æ '6000ä»¥å†…' è¿™ç§é€»è¾‘ï¼‰ã€‚
    """
    if not keywords:
        logger.info("search_houses called with empty keywords. Skip search.")
        return []

    results = []
    
    # é¢„å¤„ç†ï¼šå°† mock æ•°æ®è½¬ä¸ºæ˜“äºæœç´¢çš„å­—ç¬¦ä¸²æ ¼å¼
    for house in MOCK_HOUSES:
        # æ‹¼åˆæ‰€æœ‰ä¿¡æ¯ç”¨äºæ¨¡ç³ŠåŒ¹é…: "å—å±± ç§‘æŠ€å›­ ä¸€å±…å®¤ 6500 ..."
        house_content = f"{house['area']} {house['location']} {house['type']} {house['price']} {house['desc']} {' '.join(house['tags'])}"
        
        score = 0
        for kw in keywords:
            if not kw: continue
            
            # ç®€å•çš„æ¨¡ç³ŠåŒ¹é…
            if kw in house_content:
                score += 1
            
            # ğŸ’¡ ç¨å¾®é«˜çº§ä¸€ç‚¹çš„ä»·æ ¼åŒ¹é…é€»è¾‘ï¼ˆMockç‰ˆï¼‰
            # å¦‚æœå…³é”®è¯æ˜¯æ•°å­—ï¼ˆå¦‚ "5000"ï¼‰ï¼Œæˆ‘ä»¬å°è¯•åŒ¹é…ä»·æ ¼åŒºé—´
            if kw.isdigit():
                budget = int(kw)
                # å‡è®¾ç”¨æˆ·è¾“å…¥çš„æ•°å­—æ˜¯é¢„ç®—ä¸Šé™ï¼Œæˆ‘ä»¬æ¨èé¢„ç®—èŒƒå›´å†…æˆ–ç¨å¾®è¶…ä¸€ç‚¹ç‚¹çš„
                # è¿™é‡Œç®€å•å¤„ç†ï¼šä»·æ ¼åœ¨ é¢„ç®—-1000 åˆ° é¢„ç®—+500 ä¹‹é—´éƒ½ç®—åŒ¹é…
                if budget - 1500 <= house['price'] <= budget + 500:
                    score += 1

        # å‘½ä¸­ä»»æ„ä¸€ä¸ªå…³é”®è¯å°±ç®—åŒ¹é…ï¼ˆä½ å¯ä»¥æ”¹ä¸º score >= len(keywords) å˜æˆä¸¥æ ¼åŒ¹é…ï¼‰
        if score > 0:
            # æŠŠåŒ¹é…åº¦å­˜è¿›å»ï¼Œæ–¹ä¾¿åé¢æ’åºï¼ˆè™½ç„¶è¿™é‡Œæ²¡åšæ’åºï¼‰
            house['_score'] = score
            results.append(house)

    # æŒ‰åŒ¹é…åº¦é™åºæ’åˆ—
    results.sort(key=lambda x: x.get('_score', 0), reverse=True)

    # æœ€å¤šè¿”å› 3 æ¡
    final_results = results[:3]
    logger.info(
        "search_houses finished. keywords=%s, matched=%d, returned=%d",
        keywords,
        len(results),
        len(final_results),
    )
    return final_results